import{PeerManagerScalable}from"../../src/utils/PeerManager_scalable.js";const myNodeIdSpan=document.getElementById("myNodeId"),myUserNameSpan=document.getElementById("myUserName"),videoChannelsDiv=document.getElementById("videoChannels"),videoPlayerModal=document.getElementById("videoPlayerModal"),videoPlayer=document.getElementById("videoPlayer"),playerVideoTitle=document.getElementById("playerVideoTitle"),playerVideoOwner=document.getElementById("playerVideoOwner"),closePlayerBtn=document.getElementById("closePlayerBtn");let peerManager,myNodeId,myUserName;const peerVideoCatalogs=new Map;export function initVideosDApp(){myNodeId=localStorage.getItem("neonet_node_id"),myUserName=localStorage.getItem("neonet_user_name"),myNodeId&&myUserName?(myNodeIdSpan.textContent=myNodeId.substring(0,8)+"...",myUserNameSpan.textContent=myUserName,peerManager=new PeerManagerScalable({signalingServerUrl:"ws://localhost:8080",onPeerJoined:handlePeerJoined,onPeerLeft:handlePeerLeft,onConnectionStatusChanged:handleConnectionStatusChanged,onMessage:handlePeerMessage}),peerManager.connect({userName:myUserName,userBio:localStorage.getItem("neonet_user_bio")||""}),closePlayerBtn.addEventListener("click",closePlayerBtn),peerManager.getAllKnownPeers().forEach(e=>{e.nodeId!==myNodeId&&peerManager.sendDataToPeer(e.nodeId,{type:"video_catalog_request"})}),updateVideoChannels()):console.error("NeoNet: User ID or Name not found. Please connect to NeoNet main page first.")}function handlePeerJoined(e){console.log("[Videos] Peer Joined:",e),peerManager.sendDataToPeer(e.nodeId,{type:"video_catalog_request"}),updateVideoChannels()}function handlePeerLeft(e){console.log("[Videos] Peer Left:",e),peerVideoCatalogs.delete(e.nodeId),updateVideoChannels()}function handleConnectionStatusChanged(e){console.log("[Videos] Connection Status:",e),"disconnected"===e&&console.warn("NeoNet Videos: Desconectado do servidor de sinaliza√ß√£o.")}function handlePeerMessage(e,o){switch(console.log("[Videos] Message from",e,":",o),o.type){case"video_catalog_request":sendMyVideoCatalog(e);break;case"video_catalog_response":peerVideoCatalogs.set(e,o.catalog),updateVideoChannels();break;case"video_stream_request":getMyVideoById(o.videoId)?peerManager.sendDataToPeer(e,{type:"video_stream_response",videoId:o.videoId,streamUrl:"https://www.w3schools.com/html/mov_bbb.mp4"}):peerManager.sendDataToPeer(e,{type:"video_stream_error",videoId:o.videoId,message:"Video not found"});break;case"video_stream_response":videoPlayerModal.classList.contains("show")&&videoPlayer.dataset.videoId===o.videoId&&(videoPlayer.src=o.streamUrl,videoPlayer.play());break;case"video_stream_error":videoPlayerModal.classList.contains("show")&&videoPlayer.dataset.videoId===o.videoId&&(alert(`Erro ao carregar v√≠deo: ${o.message}`),closeVideoPlayer())}}function updateVideoChannels(){videoChannelsDiv.innerHTML="";const e=peerManager.getAllKnownPeers();if(0===e.length)return void(videoChannelsDiv.innerHTML='\n            <div class="empty-state">\n                <div class="icon">üîç</div>\n                <p>Conecte-se √† rede para ver v√≠deos de outros peers.</p>\n            </div>\n        ');const o=getMyVideos();o.length>0&&renderVideoChannel(myNodeId,myUserName,o),e.forEach(e=>{if(e.nodeId!==myNodeId){const o=peerVideoCatalogs.get(e.nodeId)||[];o.length>0&&renderVideoChannel(e.nodeId,e.userName,o)}}),""===videoChannelsDiv.innerHTML&&(videoChannelsDiv.innerHTML='\n            <div class="empty-state">\n                <div class="icon">üòî</div>\n                <p>Nenhum v√≠deo dispon√≠vel na rede no momento.</p>\n            </div>\n        ')}function renderVideoChannel(e,o,n){const a=document.createElement("div");a.className="peer-channel",a.innerHTML=`\n        <h2 class="peer-channel-header">Canal de <span>${escapeHtml(o)}</span></h2>\n        <div class="video-grid" id="videoGrid-${e}"></div>\n    `,videoChannelsDiv.appendChild(a);const d=a.querySelector(`#videoGrid-${e}`);n.forEach(n=>{const a=document.createElement("div");a.className="video-card",a.innerHTML=`\n            <div class="video-thumbnail">\n                ${n.thumbnailUrl?`<img src="${escapeHtml(n.thumbnailUrl)}" alt="${escapeHtml(n.title)}">`:"‚ñ∂Ô∏è"}\n                <span class="video-duration">${n.duration||"0:00"}</span>\n            </div>\n            <div class="video-info">\n                <div class="video-title">${escapeHtml(n.title)}</div>\n                <div class="video-owner">${escapeHtml(o)}</div>\n            </div>\n        `,a.onclick=()=>playVideo(e,n.id,n.title,o),d.appendChild(a)})}function getMyVideos(){return[{id:"my_video_1",title:"Meu Primeiro V√≠deo Offline",ownerId:myNodeId,ownerName:myUserName,thumbnailUrl:"https://via.placeholder.com/320x180?text=Video+1",duration:"2:30"},{id:"my_video_2",title:"Aventura P2P",ownerId:myNodeId,ownerName:myUserName,thumbnailUrl:"https://via.placeholder.com/320x180?text=Video+2",duration:"5:15"}]}function getMyVideoById(e){return getMyVideos().find(o=>o.id===e)}function sendMyVideoCatalog(e){const o=getMyVideos();peerManager.sendDataToPeer(e,{type:"video_catalog_response",catalog:o})}function playVideo(e,o,n,a){playerVideoTitle.textContent=n,playerVideoOwner.textContent=`De: ${a}`,videoPlayerModal.classList.add("show"),videoPlayer.src="",videoPlayer.dataset.videoId=o,e===myNodeId?getMyVideoById(o)&&(videoPlayer.src="https://www.w3schools.com/html/mov_bbb.mp4",videoPlayer.play()):peerManager.sendDataToPeer(e,{type:"video_stream_request",videoId:o})}function closeVideoPlayer(){videoPlayer.pause(),videoPlayer.src="",videoPlayerModal.classList.remove("show"),delete videoPlayer.dataset.videoId}function escapeHtml(e){const o=document.createElement("div");return o.textContent=e,o.innerHTML}