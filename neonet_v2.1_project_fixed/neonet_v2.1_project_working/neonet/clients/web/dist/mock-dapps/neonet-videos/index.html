<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoNet Videos - Streaming P2P</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, sans-serif;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        h1 {
            text-align: center;
            color: #e50914;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        .user-info {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .user-info p {
            margin: 5px 0;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .video-card {
            background-color: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }
        .video-thumbnail {
            width: 100%;
            height: 180px;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #e50914;
            position: relative;
        }
        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-duration {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .video-info {
            padding: 15px;
        }
        .video-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .video-owner {
            font-size: 0.9rem;
            color: #aaa;
        }
        .video-player-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .video-player-modal.show {
            display: flex;
        }
        .video-player-content {
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
        }
        .video-player-content video {
            width: 100%;
            max-height: 70vh;
            background-color: black;
            margin-bottom: 15px;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 2rem;
            color: white;
            cursor: pointer;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.7;
        }
        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .peer-channel-header {
            font-size: 1.8rem;
            margin-top: 30px;
            margin-bottom: 15px;
            color: #e50914;
            border-bottom: 2px solid #e50914;
            padding-bottom: 10px;
        }
        .peer-channel-header span {
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• NeoNet Videos</h1>

        <div class="user-info">
            <p>Voc√™: <span id="myUserName"></span></p>
            <p>ID: <span id="myNodeId"></span></p>
        </div>

        <div id="videoChannels">
            <!-- Video channels (peers) will be loaded here -->
            <div class="empty-state">
                <div class="icon">üîç</div>
                <p>Conecte-se √† rede para ver v√≠deos de outros peers.</p>
            </div>
        </div>
    </div>

    <div class="video-player-modal" id="videoPlayerModal">
        <div class="video-player-content">
            <button class="close-btn" id="closePlayerBtn">&times;</button>
            <video id="videoPlayer" controls autoplay></video>
            <h3 id="playerVideoTitle"></h3>
            <p id="playerVideoOwner"></p>
        </div>
    </div>

    <script src="../../src/utils/PeerManager_scalable.js"></script>
    <script>
        const myNodeIdSpan = document.getElementById("myNodeId");
        const myUserNameSpan = document.getElementById("myUserName");
        const videoChannelsDiv = document.getElementById("videoChannels");
        const videoPlayerModal = document.getElementById("videoPlayerModal");
        const videoPlayer = document.getElementById("videoPlayer");
        const playerVideoTitle = document.getElementById("playerVideoTitle");
        const playerVideoOwner = document.getElementById("playerVideoOwner");
        const closePlayerBtn = document.getElementById("closePlayerBtn");

        let peerManager;
        let myNodeId;
        let myUserName;
        const peerVideoCatalogs = new Map(); // Map<peerId, [{ id, title, ownerId, ownerName, thumbnailUrl, duration, streamUrl }]>

        document.addEventListener("DOMContentLoaded", () => {
            myNodeId = localStorage.getItem("neonet_node_id");
            myUserName = localStorage.getItem("neonet_user_name");

            if (!myNodeId || !myUserName) {
                alert("Por favor, conecte-se √† rede NeoNet na p√°gina principal primeiro e defina seu nome.");
                window.close();
                return;
            }

            myNodeIdSpan.textContent = myNodeId.substring(0, 8) + "...";
            myUserNameSpan.textContent = myUserName;

            peerManager = new PeerManagerScalable({
                signalingServerUrl: "ws://localhost:8080",
                onPeerJoined: handlePeerJoined,
                onPeerLeft: handlePeerLeft,
                onConnectionStatusChanged: handleConnectionStatusChanged,
                onMessage: handlePeerMessage
            });

            peerManager.connect({ userName: myUserName, userBio: localStorage.getItem("neonet_user_bio") || "" });

            closePlayerBtn.addEventListener("click", closeVideoPlayer);
        });

        function handlePeerJoined(peer) {
            console.log("[Videos] Peer Joined:", peer);
            // Request video catalog from the new peer
            peerManager.sendDataToPeer(peer.nodeId, { type: "video_catalog_request" });
            updateVideoChannels();
        }

        function handlePeerLeft(peer) {
            console.log("[Videos] Peer Left:", peer);
            peerVideoCatalogs.delete(peer.nodeId);
            updateVideoChannels();
        }

        function handleConnectionStatusChanged(status) {
            console.log("[Videos] Connection Status:", status);
            if (status === "disconnected") {
                alert("Desconectado do servidor de sinaliza√ß√£o. Por favor, reconecte na p√°gina principal.");
                // Optionally, clear video channels or disable functionality
            }
        }

        function handlePeerMessage(senderId, message) {
            console.log("[Videos] Message from", senderId, ":", message);
            switch (message.type) {
                case "video_catalog_request":
                    // A peer is requesting our video catalog
                    sendMyVideoCatalog(senderId);
                    break;
                case "video_catalog_response":
                    // Received video catalog from another peer
                    peerVideoCatalogs.set(senderId, message.catalog);
                    updateVideoChannels();
                    break;
                case "video_stream_request":
                    // A peer is requesting to stream one of our videos
                    // In a real scenario, this would initiate WebRTC data channel streaming
                    // For now, we'll send a mock URL or a base64 encoded small video
                    const requestedVideo = getMyVideoById(message.videoId);
                    if (requestedVideo) {
                        // Simulate sending video data (e.g., a small base64 video or a direct stream URL if possible)
                        // For this mock, we'll just send a dummy URL
                        peerManager.sendDataToPeer(senderId, { type: "video_stream_response", videoId: message.videoId, streamUrl: "https://www.w3schools.com/html/mov_bbb.mp4" }); // Example URL
                    } else {
                        peerManager.sendDataToPeer(senderId, { type: "video_stream_error", videoId: message.videoId, message: "Video not found" });
                    }
                    break;
                // Add other video-related message types as needed
            }
        }

        function updateVideoChannels() {
            videoChannelsDiv.innerHTML = "";
            const allPeers = peerManager.getAllKnownPeers();

            if (allPeers.length === 0) {
                videoChannelsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <p>Conecte-se √† rede para ver v√≠deos de outros peers.</p>
                    </div>
                `;
                return;
            }

            // Add my own channel first
            const myVideos = getMyVideos();
            if (myVideos.length > 0) {
                renderVideoChannel(myNodeId, myUserName, myVideos);
            }

            // Add other peers' channels
            allPeers.forEach(peer => {
                if (peer.nodeId !== myNodeId) {
                    const videos = peerVideoCatalogs.get(peer.nodeId) || [];
                    if (videos.length > 0) {
                        renderVideoChannel(peer.nodeId, peer.userName, videos);
                    }
                }
            });

            if (videoChannelsDiv.innerHTML === "") {
                 videoChannelsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üòî</div>
                        <p>Nenhum v√≠deo dispon√≠vel na rede no momento.</p>
                    </div>
                `;
            }
        }

        function renderVideoChannel(ownerId, ownerName, videos) {
            const channelDiv = document.createElement("div");
            channelDiv.className = "peer-channel";
            channelDiv.innerHTML = `
                <h2 class="peer-channel-header">Canal de <span>${escapeHtml(ownerName)}</span></h2>
                <div class="video-grid" id="videoGrid-${ownerId}"></div>
            `;
            videoChannelsDiv.appendChild(channelDiv);

            const videoGrid = channelDiv.querySelector(`#videoGrid-${ownerId}`);
            videos.forEach(video => {
                const videoCard = document.createElement("div");
                videoCard.className = "video-card";
                videoCard.innerHTML = `
                    <div class="video-thumbnail">
                        ${video.thumbnailUrl ? `<img src="${escapeHtml(video.thumbnailUrl)}" alt="${escapeHtml(video.title)}">` : `‚ñ∂Ô∏è`}
                        <span class="video-duration">${video.duration || "0:00"}</span>
                    </div>
                    <div class="video-info">
                        <div class="video-title">${escapeHtml(video.title)}</div>
                        <div class="video-owner">${escapeHtml(ownerName)}</div>
                    </div>
                `;
                videoCard.onclick = () => playVideo(ownerId, video.id, video.title, ownerName);
                videoGrid.appendChild(videoCard);
            });
        }

        function getMyVideos() {
            // This is where a user's local video library would be managed
            // For now, return mock videos
            return [
                { id: "my_video_1", title: "Meu Primeiro V√≠deo Offline", ownerId: myNodeId, ownerName: myUserName, thumbnailUrl: "https://via.placeholder.com/320x180?text=Video+1", duration: "2:30" },
                { id: "my_video_2", title: "Aventura P2P", ownerId: myNodeId, ownerName: myUserName, thumbnailUrl: "https://via.placeholder.com/320x180?text=Video+2", duration: "5:15" },
            ];
        }

        function getMyVideoById(videoId) {
            return getMyVideos().find(v => v.id === videoId);
        }

        function sendMyVideoCatalog(targetPeerId) {
            const myCatalog = getMyVideos();
            peerManager.sendDataToPeer(targetPeerId, { type: "video_catalog_response", catalog: myCatalog });
        }

        function playVideo(ownerId, videoId, videoTitle, videoOwnerName) {
            playerVideoTitle.textContent = videoTitle;
            playerVideoOwner.textContent = `De: ${videoOwnerName}`;
            videoPlayerModal.classList.add("show");
            videoPlayer.src = ""; // Clear previous source

            if (ownerId === myNodeId) {
                // Play my own video directly
                const video = getMyVideoById(videoId);
                if (video) {
                    videoPlayer.src = "https://www.w3schools.com/html/mov_bbb.mp4"; // Use a dummy URL for local video
                    videoPlayer.play();
                }
            } else {
                // Request stream from other peer
                peerManager.sendDataToPeer(ownerId, { type: "video_stream_request", videoId: videoId });
                // Wait for video_stream_response in handlePeerMessage
                // For now, use a dummy URL immediately for demonstration
                videoPlayer.src = "https://www.w3schools.com/html/mov_bbb.mp4"; // Example URL
                videoPlayer.play();
            }
        }

        function closeVideoPlayer() {
            videoPlayer.pause();
            videoPlayer.src = "";
            videoPlayerModal.classList.remove("show");
        }

        function escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>


