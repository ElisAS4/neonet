import{PeerManagerScalable}from"../../src/utils/PeerManager_scalable.js";const myNodeIdSpan=document.getElementById("myNodeId"),myUserNameSpan=document.getElementById("myUserName"),peerListDiv=document.getElementById("peerList"),chatHeaderDiv=document.getElementById("chatHeader"),messagesDiv=document.getElementById("messages"),messageInput=document.getElementById("messageInput"),sendMessageBtn=document.getElementById("sendMessageBtn");let peerManager,myNodeId,myUserName,activePeerId=null;const chatHistory=new Map;export function initChatDApp(){myNodeId=localStorage.getItem("neonet_node_id"),myUserName=localStorage.getItem("neonet_user_name"),myNodeId&&myUserName?(myNodeIdSpan.textContent=myNodeId.substring(0,8)+"...",myUserNameSpan.textContent=myUserName,peerManager=new PeerManagerScalable({signalingServerUrl:"ws://localhost:8080",onPeerJoined:handlePeerJoined,onPeerLeft:handlePeerLeft,onConnectionStatusChanged:handleConnectionStatusChanged,onMessage:handlePeerMessage}),peerManager.connect({userName:myUserName,userBio:localStorage.getItem("neonet_user_bio")||""}),sendMessageBtn.addEventListener("click",sendMessage),messageInput.addEventListener("keypress",e=>{"Enter"===e.key&&sendMessage()}),updatePeerList()):console.error("NeoNet: User ID or Name not found. Please connect to NeoNet main page first.")}function handlePeerJoined(e){console.log("[Chat] Peer Joined:",e),updatePeerList()}function handlePeerLeft(e){console.log("[Chat] Peer Left:",e),activePeerId===e.nodeId&&(activePeerId=null,chatHeaderDiv.textContent="Selecione um peer para conversar",messagesDiv.innerHTML="",messageInput.disabled=!0,sendMessageBtn.disabled=!0),updatePeerList()}function handleConnectionStatusChanged(e){console.log("[Chat] Connection Status:",e),"disconnected"===e&&console.warn("NeoNet Chat: Desconectado do servidor de sinalização.")}function handlePeerMessage(e,t){console.log("[Chat] Message from",e,":",t),"chat_message"===t.type&&(addMessageToHistory(e,{sender:peerManager.getPeerMetadata(e)?.userName||e.substring(0,8)+"...",message:t.text,timestamp:Date.now()}),activePeerId===e&&displayMessage({sender:peerManager.getPeerMetadata(e)?.userName||e.substring(0,8)+"...",message:t.text,timestamp:Date.now()},"received"))}function updatePeerList(){const e=peerManager.getAllKnownPeers().filter(e=>e.nodeId!==myNodeId);peerListDiv.innerHTML="",0!==e.length?e.forEach(e=>{const t=document.createElement("div");t.className="peer-item "+(activePeerId===e.nodeId?"active":""),t.innerHTML=`\n            <div class="peer-avatar">${e.userName.charAt(0).toUpperCase()}</div>\n            <div>\n                <div>${escapeHtml(e.userName)}</div>\n                <div style="font-size: 0.7rem; opacity: 0.8;">${e.nodeId.substring(0,8)}...</div>\n            </div>\n        `,t.onclick=()=>selectPeer(e.nodeId),peerListDiv.appendChild(t)}):peerListDiv.innerHTML='<div style="text-align: center; padding: 20px; opacity: 0.7;">Nenhum peer conectado.</div>'}function selectPeer(e){activePeerId=e;const t=peerManager.getPeerMetadata(e);chatHeaderDiv.textContent=`Conversando com: ${t.userName}`,messageInput.disabled=!1,sendMessageBtn.disabled=!1,displayChatHistory(e),updatePeerList()}function sendMessage(){if(!activePeerId||""===messageInput.value.trim())return;const e=messageInput.value.trim(),t={type:"chat_message",text:e};peerManager.sendDataToPeer(activePeerId,t)?(addMessageToHistory(activePeerId,{sender:myUserName,message:e,timestamp:Date.now()}),displayMessage({sender:myUserName,message:e,timestamp:Date.now()},"sent"),messageInput.value=""):alert("Não foi possível enviar a mensagem. Peer offline ou conexão P2P não estabelecida.")}function addMessageToHistory(e,t){chatHistory.has(e)||chatHistory.set(e,[]),chatHistory.get(e).push(t)}function displayChatHistory(e){messagesDiv.innerHTML="",(chatHistory.get(e)||[]).forEach(e=>{displayMessage(e,e.sender===myUserName?"sent":"received")}),messagesDiv.scrollTop=messagesDiv.scrollHeight}function displayMessage(e,t){const s=document.createElement("div");s.className=`message-bubble ${t}`,s.innerHTML=`\n        <div class="message-sender">${e.sender} (${new Date(e.timestamp).toLocaleTimeString()})</div>\n        <div>${escapeHtml(e.message)}</div>\n    `,messagesDiv.appendChild(s),messagesDiv.scrollTop=messagesDiv.scrollHeight}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}